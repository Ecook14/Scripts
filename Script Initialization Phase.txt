1. Script Initialization Phase
1.1 Start Script

Clear the terminal

Display the script banner

Log the start timestamp into:
/var/log/monitoratop.log

Read manual inputs from user:

Snap interval

Frame count

CPU threshold

All values support defaults if user presses Enter.

1.2 Root Permission Check

The script checks if the user running it is root.

If not:

Run as root.


…and exit immediately.

1.3 Detect Linux Distro

The script detects the OS using the following logic:

if [ -e /etc/centos-release ]; then
    CENTOS_VERSION=$(rpm -q --queryformat '%{VERSION}' centos-release)

    if CENTOS_VERSION == 6  -> distro="centos6"
    if CENTOS_VERSION == 7  -> distro="centos7"

elif [ -e /etc/redhat-release ] && grep -qi "alma"  /etc/redhat-release
    -> distro="alma8or9"

elif grep -qi "rocky" /etc/redhat-release
    -> distro="rocky8or9"

elif [ -e /etc/os-release ] && grep -qi "ubuntu" /etc/os-release
    -> distro="ubuntu"

else
    echo "Unsupported OS"
    exit 1
fi


Once $distro is determined, the script switches into the correct flow.

2. Distro-Specific Branch Execution

Once $distro is set, the script executes one of four flows below.

2A — CentOS 6 Flow (SysV Init)

CentOS 6 uses:

SysV init

No systemd

Old package versions

atop 1.x only (no atop2)

Steps Performed:
1. Install prerequisites
yum install -y epel-release
yum install -y atop inotify-tools

2. Enable/Start atop
chkconfig atop on
service atop start

3. Configure 24-hour atop logging

The script edits:

/etc/sysconfig/atop

It enables logging flags (e.g., LOGINTERVAL, LOGOPTS).

Then it restarts atop.

4. Create inotify trigger script

File:

/usr/local/bin/inotify-monitor.sh


Watches:

/etc/passwd

/etc/ssh/

/home/

/var/www/

Logs events into:

/var/log/inotify-events.log

5. Start inotify watcher in background
nohup bash /usr/local/bin/inotify-monitor.sh &

6. Save PID
echo $! > /var/run/inotify-monitor.pid

7. Script exits normally

All monitoring continues in the background.

Script returns user to shell.

2B — CentOS 7 Flow (systemd)

CentOS 7 uses:

systemd

atop2

modern inotify-tools

Steps Performed:
yum install -y epel-release atop inotify-tools


Enable/Start atop:

systemctl enable atop
systemctl start atop


Logging configuration under:

/etc/atop/atop.daily

/etc/sysconfig/atop

Create inotify monitor script

Same script as CentOS 6.

Create systemd unit:

File:

/etc/systemd/system/inotify-monitor.service

Enable + Start:
systemctl enable inotify-monitor
systemctl start inotify-monitor

Script exits.
2C — AlmaLinux 8/9 & Rocky 8/9 Flow

Uses:

DNF

systemd

atop2 or atop3

modern logging

Steps Performed:
dnf install -y epel-release atop inotify-tools


Enable/Start atop:

systemctl enable --now atop


Configures:

/etc/atop/*

Creates inotify script and service

Same logic as CentOS 7:

systemctl enable --now inotify-monitor

Script exits.
2D — Ubuntu (18.04–24.04) Flow

Uses:

apt

systemd

different atop package

Steps Performed:
apt update
apt install -y atop inotify-tools


Enable atop:

systemctl enable --now atop


Logging config:

/etc/default/atop

Create inotify script + systemd service
systemctl enable --now inotify-monitor

Script exits.
3. Script Finalization Phase
3.1 Clean Exit

After completing setup:

atop is running

inotify monitoring is active

Logs are generated

PID files created where applicable

systemd services are persistent (for CentOS7+/Alma/Rocky/Ubuntu)

Script prints final summary

Then the script closes.

3.2 Expected Post-Execution Output
[**] OS detected: CentOS 6.10 (KVM)
[**] Atop installed and enabled
[**] Inotify monitoring enabled
[**] Services running in background
[**] Script execution completed and closed

4. After the Script Closes

Even after returning to shell:

1. atop continues running

Through chkconfig (CentOS 6)

Through systemd (CentOS7+/Ubuntu)

2. inotify continues running

nohup (CentOS 6)

systemd (CentOS7+/Alma/Rocky/Ubuntu)

3. Monitoring is continuous

No further user interaction required.